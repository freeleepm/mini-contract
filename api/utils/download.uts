/**
 * æ–‡ä»¶ä¸‹è½½å·¥å…·
 * å¤„ç†ç§»åŠ¨ç«¯æ–‡ä»¶ä¸‹è½½çš„ç»Ÿä¸€é€»è¾‘
 */

import { getBaseURL } from '../config.uts';

/**
 * ä¸‹è½½åˆåŒæ–‡ä»¶
 * @param fileUrl æ–‡ä»¶URLï¼ˆå¯èƒ½æ˜¯ç›¸å¯¹è·¯å¾„æˆ–å®Œæ•´URLï¼‰
 * @param fileName æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰
 */
export async function downloadContractFile(fileUrl: string, fileName?: string): Promise<void> {
	if (!fileUrl) {
		throw new Error('æ–‡ä»¶URLä¸èƒ½ä¸ºç©º');
	}
	
	// ğŸ”§ å¤„ç†URLï¼šå¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ‹¼æ¥å®Œæ•´URL
	let downloadUrl = fileUrl;
	if (!fileUrl.startsWith('http://') && !fileUrl.startsWith('https://')) {
		const baseURL = getBaseURL();
		downloadUrl = baseURL + (fileUrl.startsWith('/') ? fileUrl : '/' + fileUrl);
	}
	
	console.log('ğŸ“¥ å¼€å§‹ä¸‹è½½æ–‡ä»¶:', downloadUrl);
	
	return new Promise((resolve, reject) => {
		// æ˜¾ç¤ºåŠ è½½æç¤º
		uni.showLoading({
			title: 'ä¸‹è½½ä¸­...',
			mask: true
		});
		
		// ä¸‹è½½æ–‡ä»¶
		uni.downloadFile({
			url: downloadUrl,
			success: (res) => {
				console.log('âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼ŒçŠ¶æ€ç :', res.statusCode);
				
				if (res.statusCode === 200) {
					const tempFilePath = res.tempFilePath;
					
					// ğŸ”§ æ¡ä»¶ç¼–è¯‘ï¼šä¸åŒå¹³å°ä½¿ç”¨ä¸åŒçš„ä¿å­˜æ–¹å¼
					// #ifdef APP-PLUS
					// Appç«¯ï¼šä¿å­˜åˆ°ç›¸å†Œæˆ–æ–‡ä»¶ç®¡ç†å™¨
					saveFileToLocal(tempFilePath, fileName || 'contract.pdf')
						.then(() => {
							uni.hideLoading();
							uni.showToast({
								title: 'ä¸‹è½½æˆåŠŸ',
								icon: 'success',
								duration: 2000
							});
							resolve();
						})
						.catch((error) => {
							uni.hideLoading();
							uni.showToast({
								title: 'ä¿å­˜å¤±è´¥',
								icon: 'none',
								duration: 2000
							});
							reject(error);
						});
					// #endif
					
					// #ifdef H5
					// H5ç«¯ï¼šä½¿ç”¨æµè§ˆå™¨ä¸‹è½½
					downloadFileInBrowser(tempFilePath, fileName || 'contract.pdf');
					uni.hideLoading();
					uni.showToast({
						title: 'ä¸‹è½½æˆåŠŸ',
						icon: 'success',
						duration: 2000
					});
					resolve();
					// #endif
					
					// #ifdef MP-WEIXIN
					// å¾®ä¿¡å°ç¨‹åºï¼šæ‰“å¼€æ–‡æ¡£
					uni.openDocument({
						filePath: tempFilePath,
						showMenu: true,
						success: () => {
							uni.hideLoading();
							console.log('âœ… æ–‡æ¡£æ‰“å¼€æˆåŠŸ');
							resolve();
						},
						fail: (err) => {
							uni.hideLoading();
							console.error('âŒ æ–‡æ¡£æ‰“å¼€å¤±è´¥:', err);
							uni.showToast({
								title: 'æ‰“å¼€æ–‡ä»¶å¤±è´¥',
								icon: 'none',
								duration: 2000
							});
							reject(err);
						}
					});
					// #endif
				} else {
					uni.hideLoading();
					const errorMsg = `ä¸‹è½½å¤±è´¥ï¼ŒçŠ¶æ€ç : ${res.statusCode}`;
					console.error('âŒ', errorMsg);
					uni.showToast({
						title: 'ä¸‹è½½å¤±è´¥',
						icon: 'none',
						duration: 2000
					});
					reject(new Error(errorMsg));
				}
			},
			fail: (error) => {
				uni.hideLoading();
				console.error('âŒ ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
				uni.showToast({
					title: 'ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•',
					icon: 'none',
					duration: 2000
				});
				reject(error);
			}
		});
	});
}

/**
 * Appç«¯ä¿å­˜æ–‡ä»¶åˆ°æœ¬åœ°
 */
function saveFileToLocal(tempFilePath: string, fileName: string): Promise<void> {
	return new Promise((resolve, reject) => {
		// #ifdef APP-PLUS
		// åˆ¤æ–­æ–‡ä»¶ç±»å‹
		const fileExtension = fileName.split('.').pop()?.toLowerCase() || 'pdf';
		
		// å¦‚æœæ˜¯å›¾ç‰‡ï¼Œä¿å­˜åˆ°ç›¸å†Œ
		if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
			uni.saveImageToPhotosAlbum({
				filePath: tempFilePath,
				success: () => {
					console.log('âœ… å›¾ç‰‡å·²ä¿å­˜åˆ°ç›¸å†Œ');
					resolve();
				},
				fail: (err) => {
					console.error('âŒ ä¿å­˜åˆ°ç›¸å†Œå¤±è´¥:', err);
					// å¤±è´¥æ—¶å°è¯•ä½¿ç”¨ saveFile
					fallbackSaveFile(tempFilePath, reject, resolve);
				}
			});
		} else {
			// éå›¾ç‰‡æ–‡ä»¶ï¼Œä½¿ç”¨ saveFile
			uni.saveFile({
				tempFilePath: tempFilePath,
				success: (saveRes) => {
					console.log('âœ… æ–‡ä»¶å·²ä¿å­˜:', saveRes.savedFilePath);
					
					// å°è¯•æ‰“å¼€æ–‡ä»¶
					uni.openDocument({
						filePath: saveRes.savedFilePath,
						showMenu: true,
						success: () => {
							console.log('âœ… æ–‡ä»¶å·²æ‰“å¼€');
							resolve();
						},
						fail: (err) => {
							console.error('âŒ æ‰“å¼€æ–‡ä»¶å¤±è´¥:', err);
							// è™½ç„¶æ‰“å¼€å¤±è´¥ï¼Œä½†æ–‡ä»¶å·²ä¿å­˜ï¼Œä»ç„¶è¿”å›æˆåŠŸ
							resolve();
						}
					});
				},
				fail: (err) => {
					console.error('âŒ ä¿å­˜æ–‡ä»¶å¤±è´¥:', err);
					reject(err);
				}
			});
		}
		// #endif
		
		// #ifndef APP-PLUS
		// å…¶ä»–å¹³å°é™çº§å¤„ç†
		reject(new Error('å½“å‰å¹³å°ä¸æ”¯æŒæ­¤æ“ä½œ'));
		// #endif
	});
}

/**
 * saveFileå¤±è´¥æ—¶çš„é™çº§æ–¹æ¡ˆ
 */
function fallbackSaveFile(tempFilePath: string, reject: (reason?: any) => void, resolve: () => void) {
	uni.saveFile({
		tempFilePath: tempFilePath,
		success: (saveRes) => {
			console.log('âœ… é™çº§ä¿å­˜æˆåŠŸ:', saveRes.savedFilePath);
			resolve();
		},
		fail: (err) => {
			console.error('âŒ é™çº§ä¿å­˜å¤±è´¥:', err);
			reject(err);
		}
	});
}

/**
 * H5ç«¯æµè§ˆå™¨ä¸‹è½½
 */
function downloadFileInBrowser(url: string, fileName: string) {
	// #ifdef H5
	const link = document.createElement('a');
	link.href = url;
	link.download = fileName;
	link.style.display = 'none';
	document.body.appendChild(link);
	link.click();
	document.body.removeChild(link);
	// #endif
}

/**
 * é¢„è§ˆæ–‡ä»¶ï¼ˆå…ˆä¸‹è½½åæ‰“å¼€ï¼‰
 */
export async function previewFile(fileUrl: string): Promise<void> {
	if (!fileUrl) {
		throw new Error('æ–‡ä»¶URLä¸èƒ½ä¸ºç©º');
	}
	
	// ğŸ”§ å¤„ç†URLï¼šå¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ‹¼æ¥å®Œæ•´URL
	let downloadUrl = fileUrl;
	if (!fileUrl.startsWith('http://') && !fileUrl.startsWith('https://')) {
		const baseURL = getBaseURL();
		downloadUrl = baseURL + (fileUrl.startsWith('/') ? fileUrl : '/' + fileUrl);
	}
	
	console.log('ğŸ‘ï¸ é¢„è§ˆæ–‡ä»¶:', downloadUrl);
	
	return new Promise((resolve, reject) => {
		uni.showLoading({
			title: 'åŠ è½½ä¸­...',
			mask: true
		});
		
		uni.downloadFile({
			url: downloadUrl,
			success: (res) => {
				if (res.statusCode === 200) {
					uni.openDocument({
						filePath: res.tempFilePath,
						showMenu: true,
						success: () => {
							uni.hideLoading();
							console.log('âœ… æ–‡æ¡£æ‰“å¼€æˆåŠŸ');
							resolve();
						},
						fail: (err) => {
							uni.hideLoading();
							console.error('âŒ æ–‡æ¡£æ‰“å¼€å¤±è´¥:', err);
							uni.showToast({
								title: 'æ‰“å¼€å¤±è´¥',
								icon: 'none',
								duration: 2000
							});
							reject(err);
						}
					});
				} else {
					uni.hideLoading();
					const errorMsg = `åŠ è½½å¤±è´¥ï¼ŒçŠ¶æ€ç : ${res.statusCode}`;
					console.error('âŒ', errorMsg);
					uni.showToast({
						title: 'åŠ è½½å¤±è´¥',
						icon: 'none',
						duration: 2000
					});
					reject(new Error(errorMsg));
				}
			},
			fail: (error) => {
				uni.hideLoading();
				console.error('âŒ ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
				uni.showToast({
					title: 'åŠ è½½å¤±è´¥',
					icon: 'none',
					duration: 2000
				});
				reject(error);
			}
		});
	});
}

