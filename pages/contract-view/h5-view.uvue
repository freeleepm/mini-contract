<script>
/**
 * H5é¢„è§ˆé¡µé¢ï¼ˆWebViewæ–¹å¼ï¼‰
 * 
 * ä¸“é—¨ç”¨äºé¢„è§ˆåˆåŒæ–‡æ¡£ï¼Œä¸åŒ…å«ç­¾ç½²åŠŸèƒ½
 */
import { getSealPageUrl } from '../../api/seals/index';
import { getContract, ContractStatus, type Contract } from '../../api/contracts/index';
import { downloadContractFile } from '../../api/utils/download';

export default {
	data() {
		return {
			// H5é¢„è§ˆé¡µé¢URL
			viewUrl: '' as string,
			
			// ä»»åŠ¡ID
			taskId: '' as string,
			
			// æ–‡ä»¶URLï¼ˆå¯é€‰ï¼Œç”¨äºç›´æ¥é¢„è§ˆæŒ‡å®šæ–‡ä»¶ï¼‰
			fileUrl: null as string | null,
			
			// åˆåŒçŠ¶æ€ï¼ˆä»çˆ¶é¡µé¢ä¼ é€’ï¼Œé¿å…é‡å¤è°ƒç”¨æ¥å£ï¼‰
			contractStatus: null as number | null,
			
			// åˆåŒè¯¦æƒ…ï¼ˆä»…åœ¨éœ€è¦æ—¶åŠ è½½ï¼‰
			contract: null as Contract | null,
			
			// é¡µé¢åŠ è½½çŠ¶æ€
			loading: true as boolean,
			
			// ä¸‹è½½ä¸­çŠ¶æ€
			downloading: false as boolean,
			
			// é”™è¯¯ä¿¡æ¯
			errorMessage: '' as string
		}
	},
	
	computed: {
		/**
		 * æ˜¯å¦å¯ä»¥ä¸‹è½½ï¼ˆç­¾ç½²ä»»åŠ¡å·²å®Œæˆï¼‰
		 */
		canDownload() {
			// ä¼˜å…ˆä½¿ç”¨ä¼ é€’çš„çŠ¶æ€ï¼Œå¦åˆ™ä»åˆåŒè¯¦æƒ…è·å–
			const status = this.contractStatus !== null ? this.contractStatus : this.contract?.status;
			// ContractStatus.COMPLETED = 3ï¼ˆæ•°å­—ï¼Œä¸æ˜¯å­—ç¬¦ä¸²ï¼ï¼‰
			const result = status === ContractStatus.COMPLETED;
			console.log('[H5é¢„è§ˆ] ä¸‹è½½æƒé™æ£€æŸ¥:', {
				contractStatus: this.contractStatus,
				contractDetailStatus: this.contract?.status,
				finalStatus: status,
				COMPLETED_VALUE: ContractStatus.COMPLETED,
				canDownload: result
			});
			return result;
		}
	},
	
	onLoad(options: any) {
		console.log('[H5é¢„è§ˆ] é¡µé¢åŠ è½½ï¼Œå‚æ•°:', options);
		
		// è·å–ä»»åŠ¡ID
		if (options && options.taskId) {
			this.taskId = options.taskId;
		} else {
			uni.showToast({
				title: 'ç¼ºå°‘ä»»åŠ¡ID',
				icon: 'none'
			});
			setTimeout(() => {
				uni.navigateBack();
			}, 1500);
			return;
		}
		
		// å¯é€‰ï¼šè·å–æ–‡ä»¶URL
		if (options && options.fileUrl) {
			this.fileUrl = decodeURIComponent(options.fileUrl);
			console.log('[H5é¢„è§ˆ] æ¥æ”¶åˆ°æ–‡ä»¶URL:', this.fileUrl);
		}
		
		// å¯é€‰ï¼šè·å–åˆåŒçŠ¶æ€ï¼ˆé¿å…é‡å¤è°ƒç”¨æ¥å£ï¼‰
		if (options && options.status) {
			this.contractStatus = parseInt(options.status);
			console.log('[H5é¢„è§ˆ] âœ… æ¥æ”¶åˆ°åˆåŒçŠ¶æ€:', this.contractStatus, '(æ— éœ€è°ƒç”¨æ¥å£)');
		} else {
			// å¦‚æœæ²¡æœ‰ä¼ é€’çŠ¶æ€ï¼Œæ‰è°ƒç”¨æ¥å£è·å–åˆåŒè¯¦æƒ…
			console.log('[H5é¢„è§ˆ] âš ï¸ æœªæ¥æ”¶åˆ°çŠ¶æ€å‚æ•°ï¼Œå°†è°ƒç”¨æ¥å£è·å–åˆåŒè¯¦æƒ…');
			this.loadContractDetail();
		}
		
		// æ„å»ºH5é¢„è§ˆé¡µé¢URL
		this.buildViewUrl();
	},
	
	methods: {
		/**
		 * åŠ è½½åˆåŒè¯¦æƒ…
		 */
		async loadContractDetail() {
			try {
				const response = await getContract(this.taskId);
				console.log('[H5é¢„è§ˆ] è·å–åˆåŒè¯¦æƒ…æˆåŠŸ:', response);
				console.log('[H5é¢„è§ˆ] âœ… åˆåŒçŠ¶æ€:', response?.status);
				console.log('[H5é¢„è§ˆ] âœ… åˆåŒåç§°:', response?.name);
				this.contract = response;
			} catch (error) {
				console.error('[H5é¢„è§ˆ] âŒ è·å–åˆåŒè¯¦æƒ…å¤±è´¥:', error);
			}
		},
		
		/**
		 * æ„å»ºH5é¢„è§ˆé¡µé¢URL
		 */
	async buildViewUrl() {
		try {
			// ä½¿ç”¨ç»Ÿä¸€å°ç« åº”ç”¨ï¼Œmode=view
			// âœ… getSealPageUrl ç°åœ¨æ˜¯å¼‚æ­¥å‡½æ•°ï¼Œéœ€è¦ await
			let previewUrl = await getSealPageUrl('view', this.taskId);
			console.log('[H5é¢„è§ˆ] âœ… ç»Ÿä¸€åº”ç”¨é¢„è§ˆURL (å« Seal-Token):', previewUrl);
				
				// å¦‚æœä¼ å…¥äº†fileUrlå‚æ•°ï¼Œé™„åŠ åˆ°é¢„è§ˆURLä¸Š
				if (this.fileUrl) {
					console.log('[H5é¢„è§ˆ] âœ… æ¥æ”¶åˆ°æ–‡ä»¶URLï¼Œå‡†å¤‡é™„åŠ åˆ°é¢„è§ˆé¡µé¢');
					console.log('[H5é¢„è§ˆ] ğŸ“„ åŸå§‹æ–‡ä»¶URL:', this.fileUrl);
					
					const encodedFileUrl = encodeURIComponent(this.fileUrl);
					console.log('[H5é¢„è§ˆ] ğŸ” ç¼–ç åçš„æ–‡ä»¶URL:', encodedFileUrl);
					
					previewUrl += `&fileUrl=${encodedFileUrl}`;
					console.log('[H5é¢„è§ˆ] ğŸ¯ é™„åŠ å‚æ•°åçš„å®Œæ•´URL:', previewUrl);
				} else {
					console.warn('[H5é¢„è§ˆ] âš ï¸ æœªæ¥æ”¶åˆ°æ–‡ä»¶URLå‚æ•°ï¼ŒH5é¡µé¢å°†ä½¿ç”¨é»˜è®¤é€»è¾‘');
				}
				
				this.viewUrl = previewUrl;
				console.log('[H5é¢„è§ˆ] ğŸš€ æœ€ç»ˆä¼ é€’ç»™WebViewçš„URL:', this.viewUrl);
				
				uni.showLoading({
					title: 'åŠ è½½é¢„è§ˆ...'
				});
			} catch (error) {
				console.error('[H5é¢„è§ˆ] æ„å»ºURLå¤±è´¥:', error);
				this.errorMessage = 'é¢„è§ˆé¡µé¢åŠ è½½å¤±è´¥';
				uni.showToast({
					title: this.errorMessage,
					icon: 'none'
				});
			}
		},
		
		/**
		 * H5é¡µé¢åŠ è½½å®Œæˆ
		 */
		handleLoad(e: any): void {
			console.log('[H5é¢„è§ˆ] é¡µé¢åŠ è½½å®Œæˆ:', e);
			this.loading = false;
			uni.hideLoading();
		},
		
		/**
		 * H5é¡µé¢åŠ è½½å¤±è´¥
		 */
		handleError(e: any): void {
			console.error('[H5é¢„è§ˆ] é¡µé¢åŠ è½½å¤±è´¥:', e);
			
			this.loading = false;
			this.errorMessage = 'H5é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
			
			uni.hideLoading();
			
			uni.showModal({
				title: 'é”™è¯¯',
				content: 'H5é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ',
				showCancel: true,
				confirmText: 'é‡è¯•',
				cancelText: 'è¿”å›',
				success: (res) => {
					if (res.confirm) {
						this.buildViewUrl();
					} else {
						uni.navigateBack();
					}
				}
			});
		},
		
		/**
		 * æ¥æ”¶H5é¡µé¢æ¶ˆæ¯
		 */
		handleMessage(e : WebViewMessageEvent) {
			console.log('[H5é¢„è§ˆ] âœ… æ”¶åˆ°H5æ¶ˆæ¯äº‹ä»¶');
			console.log('[H5é¢„è§ˆ] e.detail:', JSON.stringify(e.detail));
			
			// å…¼å®¹ä¸åŒç‰ˆæœ¬çš„æ¶ˆæ¯æ ¼å¼
			let data : any = null;
			
			// æ ¼å¼1: e.detail.data æ˜¯æ•°ç»„
			if (e.detail.data != null && Array.isArray(e.detail.data) && e.detail.data.length > 0) {
				data = e.detail.data[e.detail.data.length - 1];
				console.log('[H5é¢„è§ˆ] ä»æ•°ç»„è·å–æ¶ˆæ¯:', JSON.stringify(data));
			} 
			// æ ¼å¼2: e.detail.data ç›´æ¥æ˜¯å¯¹è±¡
			else if (e.detail.data != null && typeof e.detail.data === 'object') {
				data = e.detail.data;
				console.log('[H5é¢„è§ˆ] ç›´æ¥è·å–æ¶ˆæ¯å¯¹è±¡:', JSON.stringify(data));
			}
			// æ ¼å¼3: e.detail æœ¬èº«å°±æ˜¯æ¶ˆæ¯ï¼ˆæ£€æŸ¥æ˜¯å¦æœ‰ type å±æ€§ï¼‰
			else if (e.detail != null) {
				const detail = e.detail as any;
				if (detail.type != null) {
					data = detail;
					console.log('[H5é¢„è§ˆ] ä» detail è·å–æ¶ˆæ¯:', JSON.stringify(data));
				}
			}
			
			if (data == null) {
				console.log('[H5é¢„è§ˆ] âš ï¸ æ— æ³•è§£ææ¶ˆæ¯æ•°æ®');
				return;
			}
			
			const messageType = (data as any).type;
			console.log('[H5é¢„è§ˆ] å¤„ç†æ¶ˆæ¯, type:', messageType);
			
			if (messageType == 'close') {
				console.log('[H5é¢„è§ˆ] ğŸš€ H5é¡µé¢è¯·æ±‚å…³é—­ï¼Œæ‰§è¡Œ navigateBack');
				uni.navigateBack();
			} else if (messageType == 'ready') {
				console.log('[H5é¢„è§ˆ] H5é¡µé¢å·²å‡†å¤‡å°±ç»ª');
			} else if (messageType == 'ERROR') {
				this.handleH5Error((data as any).message);
			} else {
				console.log('[H5é¢„è§ˆ] æœªçŸ¥æ¶ˆæ¯ç±»å‹:', messageType);
			}
		},
		
		/**
		 * H5é”™è¯¯å¤„ç†
		 */
		handleH5Error(message: string | null): void {
			console.error('[H5é¢„è§ˆ] H5é”™è¯¯:', message);
			
			uni.showModal({
				title: 'é”™è¯¯',
				content: message || 'é¢„è§ˆè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯',
				showCancel: false
			});
		},
		
		/**
		 * ä¸‹è½½åˆåŒ
		 */
		async handleDownload(): Promise<void> {
			// å¦‚æœæ­£åœ¨ä¸‹è½½ï¼Œç›´æ¥è¿”å›
			if (this.downloading) return;
			
			// å¦‚æœç­¾ç½²æœªå®Œæˆï¼Œæ˜¾ç¤ºæç¤º
			if (!this.canDownload) {
				console.log('[H5é¢„è§ˆ] ç­¾ç½²æœªå®Œæˆï¼Œæ— æ³•ä¸‹è½½');
				uni.showToast({
					title: 'è¯·ç­‰å¾…æ‰€æœ‰ç­¾ç½²æ–¹å®Œæˆç­¾ç½²',
					icon: 'none',
					duration: 2000
				});
				return;
			}
			
			this.downloading = true;
			
			try {
				// ä¼˜å…ˆä½¿ç”¨ fileUrlï¼Œå¦åˆ™ä½¿ç”¨ contract.signedFileUrl
				const downloadUrl = this.fileUrl || (this.contract && this.contract.signedFileUrl) || '';
				
				if (!downloadUrl) {
					throw new Error('æ— æ³•è·å–ä¸‹è½½åœ°å€');
				}
				
				console.log('[H5é¢„è§ˆ] å¼€å§‹ä¸‹è½½åˆåŒ:', downloadUrl);
				
				// ä½¿ç”¨ä¸‹è½½å·¥å…·å‡½æ•°
				await downloadContractFile(downloadUrl, this.contract?.name || 'åˆåŒ');
				
			} catch (error) {
				console.error('[H5é¢„è§ˆ] ä¸‹è½½å¤±è´¥:', error);
				uni.showToast({
					title: 'ä¸‹è½½å¤±è´¥',
					icon: 'none'
				});
			} finally {
				this.downloading = false;
			}
		}
	}
}
</script>

<template>
	<view class="h5-view-container">
		<!-- åŠ è½½ä¸­æç¤º -->
		<view v-if="loading" class="loading-container">
			<view class="loading-spinner"></view>
			<text class="loading-text">åŠ è½½é¢„è§ˆä¸­...</text>
		</view>
		
		<!-- é”™è¯¯æç¤º -->
		<view v-if="errorMessage" class="error-container">
			<text class="fa fa-exclamation-circle error-icon"></text>
			<text class="error-text">{{ errorMessage }}</text>
		</view>
		
		<!-- WebView -->
		<view v-if="viewUrl && !errorMessage" class="webview-wrapper">
			<web-view 
				class="webview-content"
				:src="viewUrl"
				@load="handleLoad"
				@error="handleError"
				@message="handleMessage"
			></web-view>
		</view>
		
		<!-- åº•éƒ¨å›ºå®šæ“ä½œæ ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼Œæ ¹æ®çŠ¶æ€æ§åˆ¶æ˜¯å¦å¯ç”¨ï¼‰ -->
		<view class="bottom-bar" v-if="!errorMessage">
			<view 
				class="download-btn" 
				:class="{ 'disabled': !canDownload, 'loading': downloading }"
				@click="handleDownload"
			>
				<text class="btn-text">{{ downloading ? 'ä¸‹è½½ä¸­...' : (canDownload ? 'ä¸‹è½½åˆåŒ' : 'ç­¾ç½²å®Œæˆåå¯ä¸‹è½½') }}</text>
			</view>
		</view>
	</view>
</template>

<style>
/* FontAwesomeåŸºç¡€æ ·å¼ */
.fa {
	font-family: FontAwesome;
	font-size: 26rpx;
	font-style: normal;
	-webkit-font-smoothing: antialiased;
	-moz-osx-font-smoothing: grayscale;
}

/* é¡µé¢å®¹å™¨ */
.h5-view-container {
	flex: 1;
	background-color: #F7F9FC;
	/* ä¸ºåº•éƒ¨æŒ‰é’®é¢„ç•™ç©ºé—´ */
	padding-bottom: 128rpx;
}

/* WebViewå®¹å™¨ */
.webview-wrapper {
	flex: 1;
	width: 100%;
	height: 100%;
	position: relative;
}

.webview-content {
	flex: 1;
	width: 100%;
	height: 100%;
}

/* åŠ è½½ä¸­å®¹å™¨ */
.loading-container {
	width: 100%;
	height: 100%;
	align-items: center;
	justify-content: center;
}

.loading-spinner {
	width: 80rpx;
	height: 80rpx;
	border-width: 4rpx;
	border-style: solid;
	border-color: #E4E7ED;
	border-top-color: #00C28A;
	border-radius: 40rpx;
	animation: spin 1s linear infinite;
}

@keyframes spin {
	0% {
		transform: rotate(0deg);
	}
	100% {
		transform: rotate(360deg);
	}
}

.loading-text {
	font-size: 28rpx;
	color: #909399;
	margin-top: 30rpx;
}

/* é”™è¯¯å®¹å™¨ */
.error-container {
	width: 100%;
	height: 100%;
	align-items: center;
	justify-content: center;
	padding: 60rpx;
}

.error-icon {
	font-size: 100rpx;
	color: #F56C6C;
	margin-bottom: 30rpx;
}

.error-text {
	font-size: 30rpx;
	color: #606266;
	text-align: center;
	line-height: 50rpx;
}

/* åº•éƒ¨å›ºå®šæ“ä½œæ  */
.bottom-bar {
	position: fixed;
	bottom: 0;
	left: 0;
	right: 0;
	background-color: #FFFFFF;
	padding: 20rpx 30rpx;
	box-shadow: 0 -2rpx 10rpx rgba(0, 0, 0, 0.05);
	/* å®‰å…¨åŒºåŸŸé€‚é… */
	padding-bottom: calc(20rpx + env(safe-area-inset-bottom));
}

/* ä¸‹è½½æŒ‰é’® */
.download-btn {
	height: 88rpx;
	border-radius: 44rpx;
	background-color: #00C28A;
	flex-direction: row;
	align-items: center;
	justify-content: center;
	transition: opacity 0.3s;
}

.download-btn:active {
	opacity: 0.9;
}

.download-btn.disabled {
	background-color: #A0CFBE;
	opacity: 0.8;
}

.download-btn.loading {
	opacity: 0.8;
}

.btn-icon {
	font-size: 32rpx;
	color: #FFFFFF;
	margin-right: 8rpx;
}

.btn-text {
	font-size: 30rpx;
	color: #FFFFFF;
	font-weight: 500;
}
</style>
