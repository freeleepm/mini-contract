<script>
/**
 * H5åˆ›å»ºåˆåŒé¡µé¢ï¼ˆWebViewå®¹å™¨ + JSBridgeï¼‰
 * 
 * åŠŸèƒ½ï¼š
 * - ç»Ÿä¸€H5å°ç« åº”ç”¨æ¶æ„å…¥å£
 * - æä¾›å®Œæ•´çš„JSBridgeæ¥å£
 * - æ”¯æŒæ–‡ä»¶é€‰æ‹©ã€ç›¸æœºè°ƒç”¨ã€æ–‡ä»¶ä¸Šä¼ ç­‰åŸç”Ÿèƒ½åŠ›
 * 
 * æ”¯æŒçš„åˆ›å»ºç±»å‹ï¼š
 * - template: æ¨¡æ¿åˆ›å»º
 * - file: æ–‡ä»¶ä¸Šä¼ åˆ›å»º
 * - image: å›¾ç‰‡ä¸Šä¼ åˆ›å»º
 * 
 * @author å°ååŒå­¦AI
 * @date 2025-11-02
 */
import { getSealPageUrl } from '../../api/seals/index';
import { API_BASE_URL } from '../../api/config';

export default {
	data() {
		return {
			// H5é¡µé¢URL
			createUrl: '',
			
			// é¡µé¢åŠ è½½çŠ¶æ€
			loading: true,
			
			// é”™è¯¯ä¿¡æ¯
			errorMessage: '',
			
			// åˆ›å»ºç±»å‹ï¼štemplate/file/image
			createType: 'template',
			
			// é¢„é€‰çš„æ¨¡æ¿ID
			templateId: '',
			
		// è‰ç¨¿IDï¼ˆç»§ç»­ç¼–è¾‘è‰ç¨¿æ—¶ä½¿ç”¨ï¼‰
		draftId: '',
		
		// PDF URLï¼ˆä»AIèµ·è‰é¢„è§ˆé¡µé¢ä¼ é€’ï¼‰
		pdfUrl: '',
		
		// åˆåŒåç§°ï¼ˆä»AIèµ·è‰é¢„è§ˆé¡µé¢ä¼ é€’ï¼‰
		contractName: '',
		
		// JSBridgeçŠ¶æ€
		bridgeReady: false,
		
		// LocalStorageè½®è¯¢å®šæ—¶å™¨
		pollTimer: null as number | null,
	}
},
	
	onLoad(options) {
		console.log('[H5å®¹å™¨] é¡µé¢åŠ è½½ï¼Œå‚æ•°:', options);
		
		// è·å–åˆ›å»ºç±»å‹
		this.createType = options.type || 'template';
		console.log('[H5å®¹å™¨] åˆ›å»ºç±»å‹:', this.createType);
		
		// è·å–æ¨¡æ¿IDï¼ˆå¦‚æœæœ‰ï¼‰
		if (options.templateId) {
			this.templateId = options.templateId;
			console.log('[H5å®¹å™¨] æ¨¡æ¿ID:', this.templateId);
		}
		
		// è·å–è‰ç¨¿IDï¼ˆå¦‚æœæœ‰ï¼‰
		if (options.draftId) {
			this.draftId = options.draftId;
			console.log('[H5å®¹å™¨] è‰ç¨¿ID:', this.draftId);
		}
		
		// è·å–PDF URLï¼ˆä»AIèµ·è‰é¢„è§ˆé¡µé¢ä¼ é€’ï¼‰
		if (options.pdfUrl) {
			const decoded = decodeURIComponent(options.pdfUrl ?? '');
			this.pdfUrl = decoded || '';
			console.log('[H5å®¹å™¨] PDF URL:', this.pdfUrl);
		}
		
		// è·å–åˆåŒåç§°ï¼ˆä»AIèµ·è‰é¢„è§ˆé¡µé¢ä¼ é€’ï¼‰
		if (options.name) {
			const decoded = decodeURIComponent(options.name ?? '');
			this.contractName = decoded || '';
			console.log('[H5å®¹å™¨] åˆåŒåç§°:', this.contractName);
		}
		
		// åˆå§‹åŒ–JSBridge
		this.initBridge();
		
		// æ„å»ºH5åˆ›å»ºé¡µé¢URL
		this.buildCreateUrl();
	},
	
	onUnload() {
		console.log('[H5å®¹å™¨] é¡µé¢å¸è½½');
		// æ¸…ç†LocalStorageè½®è¯¢å®šæ—¶å™¨
		if (this.pollTimer) {
			clearInterval(this.pollTimer);
			this.pollTimer = null;
		}
		// WebViewä¼šè‡ªåŠ¨æ¸…ç†èµ„æº
	},
	
	methods: {
	/**
	 * åˆå§‹åŒ–JSBridge
	 */
	initBridge() {
		console.log('[JSBridge] åˆå§‹åŒ–');
		this.bridgeReady = true;
			
		// uni-appçš„WebViewå·²ç»è‡ªåŠ¨æ”¯æŒpostMessageé€šä¿¡
		// H5åº”ç”¨å¯ä»¥ä½¿ç”¨ uni.postMessage æˆ– window.parent.postMessage å‘é€æ¶ˆæ¯
		// æˆ‘ä»¬åœ¨ handleMessage æ–¹æ³•ä¸­æ¥æ”¶è¿™äº›æ¶ˆæ¯
		
		// å¯åŠ¨LocalStorageè½®è¯¢æœºåˆ¶ï¼ˆæ¥æ”¶H5é€šè¿‡LocalStorageå‘é€çš„æ¶ˆæ¯ï¼‰
		this.startPollingH5Messages();
	},
	
	/**
	 * å¯åŠ¨LocalStorageè½®è¯¢æœºåˆ¶
	 * ç”¨äºæ¥æ”¶H5é€šè¿‡LocalStorageå‘é€çš„æ¶ˆæ¯
	 */
	startPollingH5Messages() {
		console.log('[JSBridge] å¯åŠ¨LocalStorageè½®è¯¢æœºåˆ¶');
		
		// æ¯100msæ£€æŸ¥ä¸€æ¬¡æ˜¯å¦æœ‰æ¥è‡ªH5çš„æ¶ˆæ¯
		this.pollTimer = setInterval(() => {
			this.checkH5Messages();
		}, 100);
	},
	
	/**
	 * æ£€æŸ¥H5æ¶ˆæ¯
	 */
	checkH5Messages() {
		try {
			// è·å–æ‰€æœ‰localStorageçš„key
			const keys = uni.getStorageInfoSync().keys;
			
			// æ‰¾å‡ºæ‰€æœ‰æ¥è‡ªH5çš„bridgeæ¶ˆæ¯
			const bridgeKeys = keys.filter(key => key.startsWith('bridge_h5_to_native_'));
			
			bridgeKeys.forEach(key => {
				try {
					const messageStr = uni.getStorageSync(key);
					if (messageStr) {
						const message = JSON.parse(messageStr);
						
						console.log('[JSBridge] æ”¶åˆ°H5 LocalStorageæ¶ˆæ¯:', message);
						
						// å¤„ç†æ¶ˆæ¯ï¼ˆè°ƒç”¨handleMessageä¸­çš„é€»è¾‘ï¼‰
						this.handleH5LocalStorageMessage(message);
						
						// åˆ é™¤å·²å¤„ç†çš„æ¶ˆæ¯
						uni.removeStorageSync(key);
					}
				} catch (error) {
					console.error('[JSBridge] è§£æH5æ¶ˆæ¯å¤±è´¥:', error);
				}
			});
		} catch (error) {
			console.error('[JSBridge] æ£€æŸ¥H5æ¶ˆæ¯å¤±è´¥:', error);
		}
	},
	
	/**
	 * å¤„ç†æ¥è‡ªH5 LocalStorageçš„æ¶ˆæ¯
	 */
	handleH5LocalStorageMessage(data) {
		if (!data || !data.action) return;
		
		console.log('[JSBridge] å¤„ç†H5 LocalStorageæ¶ˆæ¯:', data);
		
		// æ ¹æ®actionç±»å‹åˆ†å‘å¤„ç†ï¼ˆä¸handleMessageä¸­çš„é€»è¾‘ä¸€è‡´ï¼‰
		switch(data.action) {
			case 'chooseFile':
				this.handleChooseFile(data);
				break;
			
			case 'chooseImage':
				this.handleChooseImage(data);
				break;
			
			case 'takePhoto':
				this.handleTakePhoto(data);
				break;
			
			case 'compressImage':
				this.handleCompressImage(data);
				break;
			
			case 'uploadFile':
				this.handleUploadFile(data);
				break;
			
			case 'created':
				this.handleCreateCompleted(data.taskId);
				break;
			
			case 'formSubmitted':
				console.log('[JSBridge] è¡¨å•æäº¤æˆåŠŸï¼Œä»»åŠ¡ID:', data.taskId);
				this.handleFormSubmitted(data.taskId);
				break;
				
			case 'cancel':
			case 'close':
				console.log('[JSBridge] å–æ¶ˆ/å…³é—­è¯·æ±‚');
				uni.navigateBack();
				break;
			
			default:
				console.log('[JSBridge] æœªçŸ¥æ¶ˆæ¯ç±»å‹:', data.action);
		}
	},
		
	/**
	 * æ„å»ºH5åˆ›å»ºé¡µé¢URLï¼ˆä½¿ç”¨ç»Ÿä¸€åº”ç”¨ï¼‰
	 */
	async buildCreateUrl() {
		try {
			// æ„å»ºé¢å¤–å‚æ•°
			const params: Record<string, string | number> = {};
			
			// å¦‚æœæœ‰æ¨¡æ¿IDï¼Œæ·»åŠ åˆ°å‚æ•°ä¸­
			if (this.templateId) {
				params.templateId = this.templateId;
					console.log('[H5å®¹å™¨] æºå¸¦æ¨¡æ¿IDå‚æ•°:', this.templateId);
				}
				
				// å¦‚æœæœ‰è‰ç¨¿IDï¼Œæ·»åŠ åˆ°å‚æ•°ä¸­
				if (this.draftId) {
					params.draftId = this.draftId;
					console.log('[H5å®¹å™¨] æºå¸¦è‰ç¨¿IDå‚æ•°:', this.draftId);
				}
				
				// å¦‚æœæœ‰PDF URLï¼Œæ·»åŠ åˆ°å‚æ•°ä¸­ï¼ˆAIèµ·è‰åŠŸèƒ½ä½¿ç”¨ï¼‰
				if (this.pdfUrl) {
					params.pdfUrl = this.pdfUrl;
					console.log('[H5å®¹å™¨] æºå¸¦PDF URLå‚æ•°:', this.pdfUrl);
				}
				
				// å¦‚æœæœ‰åˆåŒåç§°ï¼Œæ·»åŠ åˆ°å‚æ•°ä¸­ï¼ˆAIèµ·è‰åŠŸèƒ½ä½¿ç”¨ï¼‰
				if (this.contractName) {
					params.name = this.contractName;
					console.log('[H5å®¹å™¨] æºå¸¦åˆåŒåç§°å‚æ•°:', this.contractName);
				}
				
				// è·å–å½“å‰é€‰æ‹©çš„ä¼ä¸šIDï¼ˆå¦‚æœç”¨æˆ·ä»¥ä¼ä¸šèº«ä»½æ“ä½œï¼‰
				let enterpriseId: number | undefined = undefined;
				try {
					const savedIdentity = uni.getStorageSync('currentIdentity');
					console.log('[H5å®¹å™¨] è¯»å–åˆ°çš„èº«ä»½ä¿¡æ¯:', savedIdentity);
					if (savedIdentity) {
						const identity = JSON.parse(savedIdentity) as { type?: string; id?: string | number } | null;
						console.log('[H5å®¹å™¨] è§£æåçš„èº«ä»½ä¿¡æ¯:', JSON.stringify(identity));
						if (identity && identity.type === 'enterprise' && identity.id) {
							enterpriseId = Number(identity.id);  // ç¡®ä¿æ˜¯æ•°å­—ç±»å‹
							console.log('[H5å®¹å™¨] âœ… æºå¸¦ä¼ä¸šIDå‚æ•°:', enterpriseId);
						} else {
							console.log('[H5å®¹å™¨] å½“å‰æ˜¯ä¸ªäººèº«ä»½ï¼Œä¸æºå¸¦ä¼ä¸šID');
						}
					} else {
						console.log('[H5å®¹å™¨] æœªæ‰¾åˆ°èº«ä»½ä¿¡æ¯');
					}
				} catch (e) {
					console.warn('[H5å®¹å™¨] è·å–å½“å‰èº«ä»½ä¿¡æ¯å¤±è´¥:', e);
				}
				
				// å¦‚æœæœ‰ä¼ä¸šIDï¼Œæ·»åŠ åˆ°å‚æ•°ä¸­
				if (enterpriseId) {
					params.enterpriseId = enterpriseId;
				}
				
				// ğŸ”§ ä¿®å¤ï¼šæ ¹æ® createType é€‰æ‹©ç‹¬ç«‹è·¯ç”±ï¼ˆä¸å†é€šè¿‡ type å‚æ•°åŒºåˆ†ï¼‰
				let mode: 'create' | 'create-file' | 'create-image' = 'create';
				if (this.createType === 'file') {
					mode = 'create-file';
				} else if (this.createType === 'image') {
					mode = 'create-image';
				}
				
			this.createUrl = await getSealPageUrl(mode, '', params);
				console.log('[H5å®¹å™¨] âœ… H5é¡µé¢URLå·²ç”Ÿæˆ (mode=' + mode + '):', this.createUrl);
				
				uni.showLoading({
					title: 'åŠ è½½åˆ›å»ºé¡µé¢...'
				});
			} catch (error) {
				console.error('[H5å®¹å™¨] æ„å»ºURLå¤±è´¥:', error);
				this.errorMessage = 'åˆ›å»ºé¡µé¢åŠ è½½å¤±è´¥';
				uni.showToast({
					title: this.errorMessage,
					icon: 'none'
				});
			}
		},
		
		/**
		 * H5é¡µé¢åŠ è½½å®Œæˆ
		 */
		handleLoad(e) {
			console.log('[H5åˆ›å»º] é¡µé¢åŠ è½½å®Œæˆ:', e);
			this.loading = false;
			uni.hideLoading();
		},
		
		/**
		 * H5é¡µé¢åŠ è½½å¤±è´¥
		 */
		handleError(e) {
			console.error('[H5åˆ›å»º] é¡µé¢åŠ è½½å¤±è´¥:', e);
			
			this.loading = false;
			this.errorMessage = 'H5é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
			
			uni.hideLoading();
			
			uni.showModal({
				title: 'é”™è¯¯',
				content: 'H5é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ',
				showCancel: true,
				confirmText: 'é‡è¯•',
				cancelText: 'è¿”å›',
				success: (res) => {
					if (res.confirm) {
						// é‡è¯•
						this.buildCreateUrl();
					} else {
						// è¿”å›
						uni.navigateBack();
					}
				}
			});
		},
		
		/**
		 * æ¥æ”¶H5é¡µé¢æ¶ˆæ¯ï¼ˆJSBridgeæ ¸å¿ƒï¼‰
		 */
		handleMessage(e) {
			console.log('[JSBridge] æ”¶åˆ°H5æ¶ˆæ¯:', e);
			
			// è·å–æ¶ˆæ¯æ•°æ®
			const messages = e.detail.data;
			if (!messages || messages.length === 0) {
				return;
			}
			
			// å–æœ€åä¸€æ¡æ¶ˆæ¯
			const data = messages[messages.length - 1];
			console.log('[JSBridge] å¤„ç†æ¶ˆæ¯:', data);
			
			// æ ¹æ®actionç±»å‹åˆ†å‘å¤„ç†
			switch(data.action || data.type) {
				// ===== æ–‡ä»¶ç›¸å…³ =====
				case 'chooseFile':
					this.handleChooseFile(data);
					break;
				
				// ===== ç›¸æœº/å›¾ç‰‡ç›¸å…³ =====
				case 'chooseImage':
					this.handleChooseImage(data);
					break;
				
				case 'takePhoto':
					this.handleTakePhoto(data);
					break;
				
				// ===== æ–‡ä»¶å¤„ç† =====
				case 'compressImage':
					this.handleCompressImage(data);
					break;
				
				case 'uploadFile':
					this.handleUploadFile(data);
					break;
				
				// ===== ç»“æœé€šçŸ¥ =====
				case 'created':
					this.handleCreateCompleted(data.taskId);
					break;
				
				case 'formSubmitted':
					console.log('[JSBridge] è¡¨å•æäº¤æˆåŠŸï¼Œä»»åŠ¡ID:', data.taskId);
					this.handleFormSubmitted(data.taskId);
					break;
					
				case 'cancel':
				case 'close':
					console.log('[JSBridge] å–æ¶ˆ/å…³é—­è¯·æ±‚');
					uni.navigateBack();
					break;
				
				case 'ready':
					console.log('[JSBridge] H5é¡µé¢å·²å‡†å¤‡å°±ç»ª');
					break;
					
				case 'ERROR':
					this.handleH5Error(data.message);
					break;
					
				default:
					console.log('[JSBridge] æœªçŸ¥æ¶ˆæ¯ç±»å‹:', data.action || data.type);
			}
		},
		
		/**
		 * JSBridge: é€‰æ‹©æ–‡ä»¶
		 */
		async handleChooseFile(data) {
			const { callbackId, options = {} } = data;
			
			try {
				console.log('[JSBridge] é€‰æ‹©æ–‡ä»¶ï¼Œå‚æ•°:', options);
				
				// è°ƒç”¨uni-appçš„æ–‡ä»¶é€‰æ‹©å™¨
				uni.chooseFile({
					count: options.count || 1,
					extension: options.extension || ['pdf', 'doc', 'docx'],
					success: (res) => {
						// å¤„ç†æ–‡ä»¶ä¿¡æ¯
						const files = res.tempFiles.map(file => ({
							path: file.path,
							name: file.name,
							size: file.size,
							type: file.type || this.getFileType(file.name)
						}));
						
						console.log('[JSBridge] æ–‡ä»¶é€‰æ‹©æˆåŠŸ:', files);
						
						// è¿”å›ç»“æœç»™H5ï¼ˆé€šè¿‡postMessageæˆ–LocalStorageï¼‰
						this.postMessageToH5({
							action: 'chooseFileResult',
							callbackId: callbackId,
							success: true,
							data: { files }
						});
					},
					fail: (error) => {
						console.error('[JSBridge] æ–‡ä»¶é€‰æ‹©å¤±è´¥:', error);
						this.postMessageToH5({
							action: 'chooseFileResult',
							callbackId: callbackId,
							success: false,
							error: error.errMsg || 'æ–‡ä»¶é€‰æ‹©å¤±è´¥'
						});
					}
				});
			} catch (error) {
				console.error('[JSBridge] æ–‡ä»¶é€‰æ‹©å¼‚å¸¸:', error);
				this.postMessageToH5({
					action: 'chooseFileResult',
					callbackId: callbackId,
					success: false,
					error: 'æ–‡ä»¶é€‰æ‹©å¼‚å¸¸'
				});
			}
		},
		
		/**
		 * JSBridge: é€‰æ‹©å›¾ç‰‡
		 */
		async handleChooseImage(data) {
			const { callbackId, options = {} } = data;
			
			try {
				console.log('[JSBridge] é€‰æ‹©å›¾ç‰‡ï¼Œå‚æ•°:', options);
				
				uni.chooseImage({
					count: options.count || 9,
					sizeType: options.sizeType || ['original', 'compressed'],
					sourceType: options.sourceType || ['album', 'camera'],
					success: (res) => {
						// å¤„ç†å›¾ç‰‡ä¿¡æ¯
						const images = res.tempFilePaths.map((path, index) => ({
							path: path,
							size: res.tempFiles[index]?.size || 0
						}));
						
						console.log('[JSBridge] å›¾ç‰‡é€‰æ‹©æˆåŠŸ:', images);
						
						this.postMessageToH5({
							action: 'chooseImageResult',
							callbackId: callbackId,
							success: true,
							data: { images }
						});
					},
					fail: (error) => {
						console.error('[JSBridge] å›¾ç‰‡é€‰æ‹©å¤±è´¥:', error);
						this.postMessageToH5({
							action: 'chooseImageResult',
							callbackId: callbackId,
							success: false,
							error: error.errMsg || 'å›¾ç‰‡é€‰æ‹©å¤±è´¥'
						});
					}
				});
			} catch (error) {
				console.error('[JSBridge] å›¾ç‰‡é€‰æ‹©å¼‚å¸¸:', error);
				this.postMessageToH5({
					action: 'chooseImageResult',
					callbackId: callbackId,
					success: false,
					error: 'å›¾ç‰‡é€‰æ‹©å¼‚å¸¸'
				});
			}
		},
		
		/**
		 * JSBridge: æ‹ç…§
		 */
		async handleTakePhoto(data) {
			const { callbackId } = data;
			
			try {
				console.log('[JSBridge] æ‹ç…§');
				
				uni.chooseImage({
					count: 1,
					sourceType: ['camera'],
					success: (res) => {
						const image = {
							path: res.tempFilePaths[0],
							size: res.tempFiles[0]?.size || 0
						};
						
						console.log('[JSBridge] æ‹ç…§æˆåŠŸ:', image);
						
						this.postMessageToH5({
							action: 'takePhotoResult',
							callbackId: callbackId,
							success: true,
							data: { image }
						});
					},
					fail: (error) => {
						console.error('[JSBridge] æ‹ç…§å¤±è´¥:', error);
						this.postMessageToH5({
							action: 'takePhotoResult',
							callbackId: callbackId,
							success: false,
							error: error.errMsg || 'æ‹ç…§å¤±è´¥'
						});
					}
				});
			} catch (error) {
				console.error('[JSBridge] æ‹ç…§å¼‚å¸¸:', error);
				this.postMessageToH5({
					action: 'takePhotoResult',
					callbackId: callbackId,
					success: false,
					error: 'æ‹ç…§å¼‚å¸¸'
				});
			}
		},
		
		/**
		 * JSBridge: å‹ç¼©å›¾ç‰‡
		 */
		async handleCompressImage(data) {
			const { callbackId, imagePath, quality = 80 } = data;
			
			try {
				console.log('[JSBridge] å‹ç¼©å›¾ç‰‡:', imagePath);
				
				uni.compressImage({
					src: imagePath,
					quality: quality,
					success: (res) => {
						console.log('[JSBridge] å›¾ç‰‡å‹ç¼©æˆåŠŸ');
						
						this.postMessageToH5({
							action: 'compressImageResult',
							callbackId: callbackId,
							success: true,
							data: {
								compressedPath: res.tempFilePath
							}
						});
					},
					fail: (error) => {
						console.error('[JSBridge] å›¾ç‰‡å‹ç¼©å¤±è´¥:', error);
						this.postMessageToH5({
							action: 'compressImageResult',
							callbackId: callbackId,
							success: false,
							error: error.errMsg || 'å›¾ç‰‡å‹ç¼©å¤±è´¥'
						});
					}
				});
			} catch (error) {
				console.error('[JSBridge] å›¾ç‰‡å‹ç¼©å¼‚å¸¸:', error);
				this.postMessageToH5({
					action: 'compressImageResult',
					callbackId: callbackId,
					success: false,
					error: 'å›¾ç‰‡å‹ç¼©å¼‚å¸¸'
				});
			}
		},
		
		/**
		 * JSBridge: ä¸Šä¼ æ–‡ä»¶
		 */
		async handleUploadFile(data) {
			const { callbackId, filePath, fileName } = data;
			
			try {
				console.log('[JSBridge] ä¸Šä¼ æ–‡ä»¶:', fileName);
				
				// æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
				uni.showLoading({ title: 'ä¸Šä¼ ä¸­...' });
				
				// è·å–token
				const token = uni.getStorageSync('token');
				
				// ä¸Šä¼ æ–‡ä»¶
				const uploadTask = uni.uploadFile({
					url: `${API_BASE_URL}/admin-api/infra/file/upload`,
					filePath: filePath,
					name: 'file',
					header: {
						'Authorization': 'Bearer ' + token
					},
					success: (uploadRes) => {
						uni.hideLoading();
						
						try {
							const result = JSON.parse(uploadRes.data) as { code?: number; msg?: string; data?: { id?: string; url?: string } | string } | null;
							
							if (result && result.code === 0 && result.data) {
								const data = result.data;
								const fileId = typeof data === 'object' ? (data.id || '') : data;
								const fileUrl = typeof data === 'object' ? (data.url || '') : data;
								console.log('[JSBridge] æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:', result.data);
								
								this.postMessageToH5({
									action: 'uploadFileResult',
									callbackId: callbackId,
									success: true,
									data: {
										fileId: fileId,
										fileUrl: fileUrl
									}
								});
							} else {
								throw new Error((result && result.msg) || 'ä¸Šä¼ å¤±è´¥');
							}
						} catch (parseError: any) {
							console.error('[JSBridge] è§£æä¸Šä¼ ç»“æœå¤±è´¥:', parseError);
							throw new Error('è§£æå“åº”å¤±è´¥');
						}
					},
					fail: (error) => {
						uni.hideLoading();
						console.error('[JSBridge] æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
						
						this.postMessageToH5({
							action: 'uploadFileResult',
							callbackId: callbackId,
							success: false,
							error: error.errMsg || 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥'
						});
					}
				});
				
				// ç›‘å¬ä¸Šä¼ è¿›åº¦
				uploadTask.onProgressUpdate((progress) => {
					console.log('[JSBridge] ä¸Šä¼ è¿›åº¦:', progress.progress + '%');
					this.postMessageToH5({
						action: 'uploadProgress',
						callbackId: callbackId,
						progress: progress.progress
					});
				});
				
			} catch (error) {
				uni.hideLoading();
				console.error('[JSBridge] æ–‡ä»¶ä¸Šä¼ å¼‚å¸¸:', error);
				
				this.postMessageToH5({
					action: 'uploadFileResult',
					callbackId: callbackId,
					success: false,
					error: (error instanceof Error ? error.message : String(error)) || 'æ–‡ä»¶ä¸Šä¼ å¼‚å¸¸'
				});
			}
		},
		
		/**
		 * å‘H5å‘é€æ¶ˆæ¯
		 * æ³¨æ„ï¼šuni-appçš„web-viewç»„ä»¶å¯èƒ½ä¸æ”¯æŒç›´æ¥postMessage
		 * è¿™é‡Œä½¿ç”¨LocalStorageä¸­è½¬æ–¹æ¡ˆ
		 */
		postMessageToH5(message) {
			console.log('[JSBridge] å‘é€æ¶ˆæ¯åˆ°H5:', message);
			
			// æ–¹æ¡ˆï¼šé€šè¿‡LocalStorageä¸­è½¬
			const messageKey = `bridge_native_to_h5_${message.callbackId || Date.now()}`;
			uni.setStorageSync(messageKey, JSON.stringify(message));
			
			// è§¦å‘storageäº‹ä»¶ï¼ˆH5ç«¯éœ€è¦è½®è¯¢æ£€æŸ¥ï¼‰
			// æ³¨æ„ï¼šè¿™ä¸ªæ–¹æ¡ˆåœ¨å®é™…åº”ç”¨ä¸­éœ€è¦H5ç«¯é…åˆè½®è¯¢æ£€æŸ¥
		},
		
		/**
		 * è·å–æ–‡ä»¶ç±»å‹
		 */
		getFileType(fileName: string) {
			const ext = fileName.split('.').pop()?.toLowerCase() || '';
			const typeMap: Record<string, string> = {
				'pdf': 'application/pdf',
				'doc': 'application/msword',
				'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
				'jpg': 'image/jpeg',
				'jpeg': 'image/jpeg',
				'png': 'image/png'
			};
			return typeMap[ext] || 'application/octet-stream';
		},
		
		/**
		 * åˆ›å»ºåˆåŒå®Œæˆ
		 */
		handleCreateCompleted(taskId: string | number | undefined) {
			console.log('[H5åˆ›å»º] åˆ›å»ºå®Œæˆï¼Œä»»åŠ¡ID:', taskId);
			
			// æ˜¾ç¤ºæˆåŠŸæç¤º
			uni.showModal({
				title: 'åˆ›å»ºæˆåŠŸ',
				content: 'åˆåŒå·²æˆåŠŸåˆ›å»º',
				showCancel: false,
				success: () => {
					// è¿”å›å¹¶åˆ·æ–°åˆ—è¡¨
					// é€šè¿‡äº‹ä»¶æ€»çº¿æˆ–å…¶ä»–æ–¹å¼é€šçŸ¥åˆ—è¡¨é¡µåˆ·æ–°
					uni.$emit('contract-created', { taskId });
					
					// è¿”å›ä¸Šä¸€é¡µ
					uni.navigateBack();
				}
			});
		},
		
		/**
		 * è¡¨å•æäº¤æˆåŠŸ
		 */
		handleFormSubmitted(taskId: string | number | undefined) {
			console.log('[H5åˆ›å»º] è¡¨å•æäº¤æˆåŠŸï¼Œä»»åŠ¡ID:', taskId);
			
			// æ˜¾ç¤ºæˆåŠŸæç¤ºå¹¶è¿”å›
			uni.showToast({
				title: 'è¡¨å•æäº¤æˆåŠŸ',
				icon: 'success',
				duration: 1500,
				success: () => {
					// é€šçŸ¥åˆ—è¡¨é¡µåˆ·æ–°
					uni.$emit('contract-updated', { taskId });
					
					// å»¶è¿Ÿè¿”å›ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
					setTimeout(() => {
						uni.navigateBack();
					}, 1500);
				}
			});
		},
		
		/**
		 * H5é”™è¯¯å¤„ç†
		 */
		handleH5Error(message: string | undefined) {
			console.error('[H5åˆ›å»º] H5é”™è¯¯:', message);
			
			uni.showModal({
				title: 'é”™è¯¯',
				content: message || 'åˆ›å»ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯',
				showCancel: false
			});
		}
	}
}
</script>

<template>
	<view class="h5-create-container">
		<!-- åŠ è½½ä¸­æç¤º -->
		<view v-if="loading" class="loading-container">
			<view class="loading-spinner"></view>
			<text class="loading-text">åŠ è½½åˆ›å»ºé¡µé¢ä¸­...</text>
		</view>
		
		<!-- é”™è¯¯æç¤º -->
		<view v-if="errorMessage" class="error-container">
			<text class="fa fa-exclamation-circle error-icon"></text>
			<text class="error-text">{{ errorMessage }}</text>
		</view>
		
		<!-- WebView -->
		<web-view 
			v-if="createUrl && !errorMessage"
			:src="createUrl"
			@load="handleLoad"
			@error="handleError"
			@message="handleMessage"
		></web-view>
	</view>
</template>

<style>
/* FontAwesomeåŸºç¡€æ ·å¼ */
.fa {
	font-family: FontAwesome;
	font-size: 26rpx;
	font-style: normal;
	-webkit-font-smoothing: antialiased;
	-moz-osx-font-smoothing: grayscale;
}

/* é¡µé¢å®¹å™¨ */
.h5-create-container {
	width: 100%;
	height: 100%;
	background-color: #F7F9FC;
}

/* åŠ è½½ä¸­å®¹å™¨ */
.loading-container {
	width: 100%;
	height: 100%;
	align-items: center;
	justify-content: center;
}

.loading-spinner {
	width: 80rpx;
	height: 80rpx;
	border-width: 4rpx;
	border-style: solid;
	border-color: #E4E7ED;
	border-top-color: #00C28A;
	border-radius: 40rpx;
	animation: spin 1s linear infinite;
}

@keyframes spin {
	0% {
		transform: rotate(0deg);
	}
	100% {
		transform: rotate(360deg);
	}
}

.loading-text {
	font-size: 28rpx;
	color: #909399;
	margin-top: 30rpx;
}

/* é”™è¯¯å®¹å™¨ */
.error-container {
	width: 100%;
	height: 100%;
	align-items: center;
	justify-content: center;
	padding: 60rpx;
}

.error-icon {
	font-size: 100rpx;
	color: #F56C6C;
	margin-bottom: 30rpx;
}

.error-text {
	font-size: 30rpx;
	color: #606266;
	text-align: center;
	line-height: 50rpx;
}
</style>

