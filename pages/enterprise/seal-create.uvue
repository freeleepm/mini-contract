<script>
/**
 * ä¼ä¸šå°ç« åˆ›å»ºé¡µé¢
 * 
 * é€šè¿‡WebViewåŠ è½½ç»Ÿä¸€çš„å°ç« åˆ›å»ºåº”ç”¨
 * - ä¸ä¸ªäººå°ç« åˆ›å»ºé€»è¾‘ä¿æŒä¸€è‡´ï¼ˆä½¿ç”¨ç›¸åŒçš„sealæ¨¡å—ï¼‰
 * - åŒºåˆ«åœ¨äºéœ€è¦ä¼ é€’ enterpriseId å‚æ•°
 * - æ”¯æŒæ‰‹å†™ç­¾åã€ä¸Šä¼ å›¾ç‰‡ã€æ¨¡æ¿ç”Ÿæˆä¸‰ç§åˆ›å»ºæ–¹å¼
 */
import { getSealPageUrl } from '../../api/seals/index';
import { checkNetworkStatus, testH5ServiceAvailability } from '../../utils/network';
import { SEAL_CORE_H5_URL } from '../../api/config';

export default {
  data() {
    return {
			// ä¼ä¸šID
			enterpriseId: null as number | null,
			
			// ä¼ä¸šåç§°ï¼ˆç”¨äºå°ç« åˆ›å»ºæ—¶è‡ªåŠ¨å¡«å……ï¼‰
			enterpriseName: '' as string,
			
			// åˆ›å»ºé¡µé¢URL
			createUrl: '',
			
			// é¡µé¢åŠ è½½çŠ¶æ€
			loading: true,
			
			// é”™è¯¯ä¿¡æ¯
			errorMessage: ''
		}
	},
	
	onLoad(options: { enterpriseId?: string; enterpriseName?: string }) {
		console.log('[ä¼ä¸šå°ç« åˆ›å»º] é¡µé¢åŠ è½½ï¼Œå‚æ•°:', options);
		
		// è·å–ä¼ä¸šID
		if (options.enterpriseId) {
			this.enterpriseId = parseInt(options.enterpriseId);
			console.log('[ä¼ä¸šå°ç« åˆ›å»º] ä¼ä¸šID:', this.enterpriseId);
		} else {
			console.error('[ä¼ä¸šå°ç« åˆ›å»º] âŒ ç¼ºå°‘ä¼ä¸šIDå‚æ•°');
			this.errorMessage = 'ç¼ºå°‘ä¼ä¸šIDå‚æ•°';
			uni.showModal({
				title: 'é”™è¯¯',
				content: 'ç¼ºå°‘å¿…è¦çš„ä¼ä¸šIDå‚æ•°ï¼Œè¯·è¿”å›é‡è¯•',
				showCancel: false,
				confirmText: 'è¿”å›',
				success: () => {
					uni.navigateBack();
				}
			});
			return;
		}
		
		// è·å–ä¼ä¸šåç§°ï¼ˆç”¨äºè‡ªåŠ¨å¡«å……ï¼‰
		if (options.enterpriseName) {
			this.enterpriseName = decodeURIComponent(options.enterpriseName) || '';
			console.log('[ä¼ä¸šå°ç« åˆ›å»º] ä¼ä¸šåç§°:', this.enterpriseName);
		}
		
		// æ„å»ºåˆ›å»ºé¡µé¢URL
		this.buildCreateUrl();
  },
  
  methods: {
	/**
	 * æ„å»ºä¼ä¸šå°ç« åˆ›å»ºé¡µé¢URL
	 */
	async buildCreateUrl() {
		try {
			// ğŸ”§ æ­¥éª¤ 1: æ£€æŸ¥ç½‘ç»œçŠ¶æ€
			uni.showLoading({ title: 'æ­£åœ¨æ£€æµ‹ç½‘ç»œ...', mask: true });
			const networkResult = await checkNetworkStatus();
			
			if (!networkResult.success) {
				uni.hideLoading();
				this.loading = false;
				this.errorMessage = networkResult.errorMessage || 'ç½‘ç»œè¿æ¥å¤±è´¥';
				uni.showModal({
					title: 'ç½‘ç»œå¼‚å¸¸',
					content: networkResult.errorMessage || 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•',
					showCancel: true,
					confirmText: 'é‡è¯•',
					cancelText: 'è¿”å›',
					success: (res) => {
						if (res.confirm) {
							this.reloadPage();
						} else {
							uni.navigateBack();
						}
					}
				});
				return;
			}
			
			// ğŸ”§ æ­¥éª¤ 2: æ£€æŸ¥ H5 æœåŠ¡å¯ç”¨æ€§
			uni.showLoading({ title: 'æ­£åœ¨æ£€æµ‹æœåŠ¡...', mask: true });
			const serviceResult = await testH5ServiceAvailability(SEAL_CORE_H5_URL);
			
			if (!serviceResult.available) {
				uni.hideLoading();
				this.loading = false;
				this.errorMessage = serviceResult.errorMessage || 'H5æœåŠ¡æš‚æ—¶ä¸å¯ç”¨';
				uni.showModal({
					title: 'æœåŠ¡å¼‚å¸¸',
					content: serviceResult.errorMessage || 'H5æœåŠ¡æš‚æ—¶ä¸å¯ç”¨\nè¯·ç¨åé‡è¯•æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ',
					showCancel: true,
					confirmText: 'é‡è¯•',
					cancelText: 'è¿”å›',
					success: (res) => {
						if (res.confirm) {
							this.reloadPage();
						} else {
							uni.navigateBack();
						}
					}
				});
				return;
			}
			
			// ğŸ”§ æ­¥éª¤ 3: æ„å»ºåˆ›å»ºé¡µé¢ URL
			uni.showLoading({ title: 'æ­£åœ¨è¿æ¥å°ç« æœåŠ¡...', mask: true });
			
			// ä½¿ç”¨ç»Ÿä¸€å°ç« åº”ç”¨ï¼Œmode=seal-createï¼Œå¹¶ä¼ é€’ enterpriseId å’Œ enterpriseName
			this.createUrl = await getSealPageUrl('seal-create', undefined, {
				enterpriseId: this.enterpriseId,
				enterpriseName: this.enterpriseName  // ğŸ†• ä¼ é€’ä¼ä¸šåç§°
			});
			
			console.log('[ä¼ä¸šå°ç« åˆ›å»º] âœ… ç»Ÿä¸€åº”ç”¨åˆ›å»ºURL (å« Seal-Tokenã€enterpriseId å’Œ enterpriseName):', this.createUrl);
			
		} catch (error: any) {
			console.error('[ä¼ä¸šå°ç« åˆ›å»º] âŒ æ„å»ºURLå¤±è´¥:', error);
			uni.hideLoading();
			this.loading = false;
			this.errorMessage = 'å°ç« åˆ›å»ºé¡µé¢åŠ è½½å¤±è´¥';
			uni.showModal({
				title: 'é”™è¯¯',
				content: 'å°ç« åˆ›å»ºé¡µé¢åŠ è½½å¤±è´¥\nè¯·ç¨åé‡è¯•æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ',
				showCancel: true,
				confirmText: 'é‡è¯•',
				cancelText: 'è¿”å›',
				success: (res) => {
					if (res.confirm) {
						this.reloadPage();
					} else {
						uni.navigateBack();
					}
				}
			});
		}
		// âœ… ä¸åœ¨è¿™é‡Œè®¾ç½® loading = falseï¼Œåº”è¯¥åœ¨ handleLoad ä¸­è®¾ç½®
	},
		
		/**
		 * H5é¡µé¢åŠ è½½å®Œæˆ
		 */
		handleLoad(e) {
			console.log('[ä¼ä¸šå°ç« åˆ›å»º] é¡µé¢åŠ è½½å®Œæˆ:', e);
			
			this.loading = false;
			
			uni.hideLoading();
		},
		
		/**
		 * é¡µé¢åŠ è½½å¤±è´¥
		 */
		handleError(e) {
			console.error('[ä¼ä¸šå°ç« åˆ›å»º] é¡µé¢åŠ è½½å¤±è´¥:', e);
			
			this.loading = false;
			this.errorMessage = 'é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
			
			uni.hideLoading();
			
			uni.showModal({
				title: 'é”™è¯¯',
				content: 'é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ',
				showCancel: true,
				confirmText: 'é‡è¯•',
				cancelText: 'è¿”å›',
        success: (res) => {
					if (res.confirm) {
						// é‡è¯•ï¼šæ¸…é™¤é”™è¯¯å¹¶é‡æ–°æ„å»ºURL
						this.errorMessage = '';
						this.buildCreateUrl();
					} else {
						uni.navigateBack();
					}
				}
			});
		},
		
		/**
		 * æ¥æ”¶é¡µé¢æ¶ˆæ¯
		 */
		handleMessage(e) {
			console.log('[ä¼ä¸šå°ç« åˆ›å»º] æ”¶åˆ°æ¶ˆæ¯:', e);
			
			const messages = e.detail.data;
			if (!messages || messages.length === 0) {
								return;
							}
							
			const data = messages[messages.length - 1];
			console.log('[ä¼ä¸šå°ç« åˆ›å»º] å¤„ç†æ¶ˆæ¯:', data);
			
			switch(data.type) {
				case 'seal-created':
					this.handleSealCreated(data.data);
					break;
					
				case 'close':
					this.handleClose();
					break;
					
				case 'error':
					this.handleCreateError(data.data?.message || 'æœªçŸ¥é”™è¯¯');
					break;
					
				default:
					console.log('[ä¼ä¸šå°ç« åˆ›å»º] æœªçŸ¥æ¶ˆæ¯ç±»å‹:', data.type);
			}
		},
		
		/**
		 * å°ç« åˆ›å»ºæˆåŠŸå¤„ç†
		 */
		handleSealCreated(sealInfo) {
			console.log('[ä¼ä¸šå°ç« åˆ›å»º] åˆ›å»ºæˆåŠŸ:', sealInfo);
			
			uni.hideLoading();
			
			uni.showToast({
				title: 'ä¼ä¸šå°ç« åˆ›å»ºæˆåŠŸ',
				icon: 'success',
				duration: 1500
			});
			
			setTimeout(() => {
				// è¿”å›ä¸Šä¸€é¡µå¹¶è§¦å‘åˆ·æ–°äº‹ä»¶
				uni.navigateBack();
				
				// å‘é€å…¨å±€äº‹ä»¶é€šçŸ¥ä¼ä¸šå°ç« åˆ—è¡¨åˆ·æ–°
				uni.$emit('refreshEnterpriseSealList');
			}, 1500);
		},
		
		/**
		 * ç”¨æˆ·å–æ¶ˆåˆ›å»º
		 */
		handleClose() {
			console.log('[ä¼ä¸šå°ç« åˆ›å»º] ç”¨æˆ·å–æ¶ˆæ“ä½œ');
			
			uni.hideLoading();
			
			uni.navigateBack();
		},
		
		/**
		 * åˆ›å»ºé”™è¯¯å¤„ç†
		 */
		handleCreateError(message) {
			console.error('[ä¼ä¸šå°ç« åˆ›å»º] åˆ›å»ºé”™è¯¯:', message);
        
        uni.hideLoading();
				
			uni.showModal({
				title: 'é”™è¯¯',
				content: message || 'å°ç« åˆ›å»ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯',
				showCancel: false,
				confirmText: 'ç¡®å®š'
			});
		},
		
		/**
		 * é‡æ–°åŠ è½½é¡µé¢
		 */
		reloadPage() {
			console.log('[ä¼ä¸šå°ç« åˆ›å»º] é‡æ–°åŠ è½½é¡µé¢');
			
			// æ¸…é™¤é”™è¯¯çŠ¶æ€
			this.errorMessage = '';
			this.loading = true;
			
			// é‡æ–°æ„å»ºURLï¼ˆä¼šè‡ªåŠ¨æ˜¾ç¤ºloadingï¼‰
			this.buildCreateUrl();
    }
  }
}
</script>

<template>
  <view class="seal-create-container">
    <!-- åŠ è½½ä¸­æç¤º -->
    <view v-if="loading" class="loading-container">
      <view class="loading-spinner"></view>
      <text class="loading-text">æ­£åœ¨è¿æ¥å°ç« æœåŠ¡...</text>
    </view>
    
    <!-- é”™è¯¯æç¤º -->
    <view v-if="errorMessage" class="error-container">
      <text class="fa fa-circle-exclamation error-icon"></text>
      <text class="error-title">åŠ è½½å¤±è´¥</text>
      <text class="error-text">{{ errorMessage }}</text>
      <view class="error-buttons">
        <view class="error-btn secondary" @click="() => uni.navigateBack()">
          <text class="btn-text">è¿”å›</text>
        </view>
        <view class="error-btn primary" @click="reloadPage">
          <text class="fa fa-rotate-right btn-icon"></text>
          <text class="btn-text">é‡æ–°åŠ è½½</text>
        </view>
      </view>
    </view>
    
    <!-- WebView -->
    <web-view 
      v-if="createUrl && !errorMessage"
      :src="createUrl"
      class="webview"
      @load="handleLoad"
      @error="handleError"
      @message="handleMessage"
    ></web-view>
  </view>
</template>

<style scoped>
@import url('../../static/styles/fontawesome.css');

.seal-create-container {
  flex: 1;
  background-color: #F7F8FA;
  display: flex;
  flex-direction: column;
}

/* ============ åŠ è½½ä¸­æ ·å¼ ============ */
.loading-container {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  background-color: #FFFFFF;
}

.loading-spinner {
  width: 64rpx;
  height: 64rpx;
  border: 4rpx solid #E5E6EB;
  border-top-color: #00C28A;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 24rpx;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.loading-text {
  font-size: 28rpx;
  color: #86909C;
  font-weight: 500;
}

/* ============ é”™è¯¯æç¤ºæ ·å¼ ============ */
.error-container {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  padding: 60rpx;
  background-color: #FFFFFF;
}

.error-icon {
  font-family: FontAwesome;
  font-size: 96rpx;
  color: #F53F3F;
  margin-bottom: 24rpx;
}

.error-title {
  font-size: 32rpx;
  font-weight: 600;
  color: #1D2129;
  margin-bottom: 12rpx;
}

.error-text {
  font-size: 26rpx;
  color: #86909C;
  text-align: center;
  margin-bottom: 48rpx;
  line-height: 1.5;
}

.error-buttons {
  display: flex;
  flex-direction: row;
  justify-content: center;
  gap: 24rpx;
}

.error-btn {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  padding: 0 40rpx;
  height: 72rpx;
  border-radius: 8rpx; /* å°åœ†è§’ï¼Œå•†åŠ¡é£ */
  min-width: 200rpx;
}

.error-btn.primary {
  background-color: #00C28A;
}

.error-btn.secondary {
  background-color: #F7F8FA;
  border: 1rpx solid #E5E6EB;
}

.btn-icon {
  font-family: FontAwesome;
  font-size: 24rpx;
  margin-right: 8rpx;
}

.error-btn.primary .btn-icon,
.error-btn.primary .btn-text {
  color: #FFFFFF;
}

.error-btn.secondary .btn-text {
  color: #4E5969;
}

.btn-text {
  font-size: 28rpx;
  font-weight: 500;
}

.webview {
  flex: 1;
  width: 100%;
  height: 100%;
}
</style>
