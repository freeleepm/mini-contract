<template>
	<view class="h5-sign-container">
		<!-- åŠ è½½çŠ¶æ€ -->
		<H5LoadingContainer 
			v-if="loading && !errorMessage"
			loadingText="æ­£åœ¨åŠ è½½ç­¾ç½²é¡µé¢..."
		/>

		<!-- é”™è¯¯æç¤º -->
		<H5ErrorContainer
			v-if="errorMessage && !loading"
			:errorMessage="errorMessage"
			@back="goBack"
			@retry="manualRetry"
			@contact-support="contactSupport"
		/>

		<!-- H5 WebView -->
		<web-view
			v-if="signUrl && !errorMessage && !loading"
			:src="signUrl"
			@load="handleLoad"
			@error="handleError"
			@message="handleMessage"
			class="h5-webview"
		></web-view>
	</view>
</template>

<script>
/**
 * H5ç­¾ç½²é¡µé¢ï¼ˆWebViewæ–¹å¼ï¼‰
 * 
 * ä¸“é—¨ç”¨äºç­¾ç½²åˆåŒï¼Œä¸åŒ…å«é¢„è§ˆåŠŸèƒ½
 * - é¢„è§ˆåŠŸèƒ½å·²ç‹¬ç«‹åˆ° pages/contract-view/h5-view.uvue
 * 
 * âš ï¸ é‡è¦è¯´æ˜ï¼š
 * H5 æœåŠ¡æ£€æµ‹å·²åœ¨åˆåŒåˆ—è¡¨é¡µå®Œæˆï¼
 * æœ¬é¡µé¢èŒè´£å·²ç®€åŒ–ä¸ºï¼š
 * 1. è·å– H5 URLï¼ˆå·²é¢„å…ˆéªŒè¯å¯ç”¨ï¼‰
 * 2. åŠ è½½ WebView
 * 3. å¤„ç†ç­¾ç½²å›è°ƒå’Œè¿è¡Œæ—¶é”™è¯¯
 */
import { getSealPageUrl, submitSignResult } from '../../api/seals/index';
import { 
	analyzeWebViewError,
	getErrorMessage,
	ErrorType,
	type ErrorTypeValue
} from '../../utils/network';
import H5LoadingContainer from '../../components/H5LoadingContainer.uvue';
import H5ErrorContainer from '../../components/H5ErrorContainer.uvue';

export default {
	components: {
		H5LoadingContainer,
		H5ErrorContainer
	},
	
	data() {
		return {
			// H5ç­¾ç½²é¡µé¢URL
			signUrl: '' as string,
			
			// ä»»åŠ¡ID
			taskId: '' as string,
			
			// æ–‡ä»¶IDï¼ˆå¯é€‰ï¼‰
			fileId: '' as string,
			
			// é¡µé¢åŠ è½½çŠ¶æ€
			loading: true as boolean,
			
			// é”™è¯¯ä¿¡æ¯ï¼ˆä»…ç”¨äºè¿è¡Œæ—¶é”™è¯¯ï¼‰
			errorMessage: '' as string,
			
			// é”™è¯¯ç±»å‹ï¼ˆä»…ç”¨äºè¿è¡Œæ—¶é”™è¯¯ï¼‰
			errorType: '' as string
		}
	},
	
	onLoad(options: any) {
		console.log('[H5ç­¾ç½²] é¡µé¢åŠ è½½ï¼Œå‚æ•°:', options);
		
		// è·å–ä»»åŠ¡ID
		if (options && options.taskId) {
			this.taskId = options.taskId;
		} else {
			uni.showToast({
				title: 'ç¼ºå°‘ä»»åŠ¡ID',
				icon: 'none'
			});
			setTimeout(() => {
				uni.navigateBack();
			}, 1500);
			return;
		}
		
		// å¯é€‰ï¼šè·å–æ–‡ä»¶ID
		if (options && options.fileId) {
			this.fileId = options.fileId;
		}
		
		// ç›´æ¥åŠ è½½ç­¾ç½²URLï¼ˆH5 æœåŠ¡æ£€æµ‹å·²åœ¨åˆ—è¡¨é¡µå®Œæˆï¼‰
		this.buildSignUrl();
	},
	
	methods: {
	/**
	 * æ„å»ºç­¾ç½²URL
	 * æ³¨æ„ï¼šH5 æœåŠ¡æ£€æµ‹å·²åœ¨åˆ—è¡¨é¡µå®Œæˆï¼Œæ­¤å¤„åªåšåŸºæœ¬çš„é”™è¯¯å…œåº•
	 */
	async buildSignUrl() {
		try {
			uni.showLoading({ title: 'æ­£åœ¨åŠ è½½ç­¾ç½²é¡µé¢...' });
			
			this.signUrl = await getSealPageUrl('sign', this.taskId);
			console.log('[H5ç­¾ç½²] ç­¾ç½²URLå·²è·å–:', this.signUrl);
			
			// ğŸ”§ å…³é”®ä¿®å¤ï¼šæ›´æ–°loadingçŠ¶æ€ï¼Œè®©WebViewæ˜¾ç¤ºå‡ºæ¥
			this.loading = false;
			uni.hideLoading();
		} catch (error) {
			console.error('[H5ç­¾ç½²] è·å–URLå¤±è´¥ï¼ˆä¸åº”å‘ç”Ÿï¼Œå› ä¸ºåˆ—è¡¨é¡µå·²æ£€æµ‹ï¼‰:', error);
			
			this.loading = false;
			uni.hideLoading();
			
			// å…œåº•é”™è¯¯æç¤º
			this.errorType = ErrorType.SERVER;
			this.errorMessage = 'æ— æ³•åŠ è½½ç­¾ç½²é¡µé¢\nè¯·è¿”å›é‡è¯•æˆ–è”ç³»å®¢æœ';
		}
	},
		
		/**
		 * WebViewåŠ è½½å®Œæˆ
		 */
		handleLoad(e: any): void {
			console.log('[H5ç­¾ç½²] WebViewåŠ è½½æˆåŠŸ');
			this.loading = false;
			uni.hideLoading();
		},
		
		/**
		 * WebViewåŠ è½½å¤±è´¥
		 */
		handleError(e: any): void {
			console.error('[H5ç­¾ç½²] WebViewåŠ è½½å¤±è´¥:', e);
			
			this.loading = false;
			uni.hideLoading();
			
			// ä½¿ç”¨ç½‘ç»œå·¥å…·åˆ†æé”™è¯¯ç±»å‹
			this.errorType = analyzeWebViewError(e);
			this.errorMessage = getErrorMessage(this.errorType as ErrorTypeValue);
			
			console.log('[H5ç­¾ç½²] WebViewåŠ è½½å¤±è´¥ï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ');
		},
		
		/**
		 * å¤„ç†H5é¡µé¢æ¶ˆæ¯
		 */
		handleMessage(e: any): void {
			console.log('[H5ç­¾ç½²] æ”¶åˆ°H5æ¶ˆæ¯:', e);
			
			const data = e.detail.data[0];
			
			if (!data) {
				console.warn('[H5ç­¾ç½²] æ¶ˆæ¯æ•°æ®ä¸ºç©º');
				return;
			}
			
			// å¤„ç†ç­¾ç½²å®Œæˆæ¶ˆæ¯
			if (data.type === 'signComplete') {
				this.handleSignComplete(data);
			}
			// å¤„ç†ç­¾ç½²å–æ¶ˆæ¶ˆæ¯
			else if (data.type === 'signCancel') {
				this.handleSignCancel();
			}
			// å¤„ç†ç­¾ç½²é”™è¯¯æ¶ˆæ¯
			else if (data.type === 'signError') {
				this.handleSignError(data);
			}
		},
		
		/**
		 * å¤„ç†ç­¾ç½²å®Œæˆ
		 */
		async handleSignComplete(data: any) {
			console.log('[H5ç­¾ç½²] ç­¾ç½²å®Œæˆ:', data);
			
			try {
				// æäº¤ç­¾ç½²ç»“æœåˆ°åç«¯
				if (data.signData) {
					await submitSignResult({
						taskId: this.taskId,
						signedFileUrl: data.signData
					});
				}
				
				// æ˜¾ç¤ºæˆåŠŸæç¤º
				uni.showToast({
					title: 'ç­¾ç½²æˆåŠŸ',
					icon: 'success',
					duration: 2000
				});
				
				// å»¶è¿Ÿè¿”å›
				setTimeout(() => {
					uni.navigateBack();
				}, 2000);
			} catch (error) {
				console.error('[H5ç­¾ç½²] æäº¤ç­¾ç½²ç»“æœå¤±è´¥:', error);
				uni.showToast({
					title: 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•',
					icon: 'none'
				});
			}
		},
		
		/**
		 * å¤„ç†ç­¾ç½²å–æ¶ˆ
		 */
		handleSignCancel(): void {
			console.log('[H5ç­¾ç½²] ç”¨æˆ·å–æ¶ˆç­¾ç½²');
			
			uni.showModal({
				title: 'ç¡®è®¤å–æ¶ˆ',
				content: 'ç¡®å®šè¦å–æ¶ˆç­¾ç½²å—ï¼Ÿ',
				success: (res) => {
					if (res.confirm) {
						uni.navigateBack();
					}
				}
			});
		},
		
		/**
		 * å¤„ç†ç­¾ç½²é”™è¯¯
		 */
		handleSignError(data: any): void {
			console.error('[H5ç­¾ç½²] ç­¾ç½²é”™è¯¯:', data);
			
			uni.showToast({
				title: data.message || 'ç­¾ç½²å¤±è´¥',
				icon: 'none',
				duration: 3000
			});
		},
		
		/**
		 * æ‰‹åŠ¨é‡è¯•
		 */
		manualRetry(): void {
			console.log('[H5ç­¾ç½²] ç”¨æˆ·æ‰‹åŠ¨é‡è¯•');
			this.resetErrorState();
			this.buildSignUrl();
		},
		
		/**
		 * é‡ç½®é”™è¯¯çŠ¶æ€
		 */
		resetErrorState(): void {
			this.errorMessage = '';
			this.errorType = '';
			this.loading = true;
			this.signUrl = '';
		},
		
		/**
		 * è¿”å›ä¸Šä¸€é¡µ
		 */
		goBack(): void {
			uni.navigateBack();
		},
		
		/**
		 * è”ç³»å®¢æœ
		 */
		contactSupport(): void {
			uni.showModal({
				title: 'è”ç³»å®¢æœ',
				content: 'å®¢æœç”µè¯ï¼š400-xxx-xxxx\næˆ–å‘é€é‚®ä»¶è‡³ï¼šsupport@example.com',
				showCancel: false
			});
		}
	}
}
</script>

<style>
.h5-sign-container {
	flex: 1;
	width: 100%;
	height: 100%;
	background-color: #F7F9FC;
}

.h5-webview {
	width: 100%;
	height: 100%;
}
</style>
